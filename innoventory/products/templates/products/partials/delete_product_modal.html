<div class="modal fade" id="deleteProductModal" tabindex="-1" aria-labelledby="deleteProductModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteProductModalLabel">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="modalMessages"></div>
                <p>Are you sure you want to delete <strong id="deleteItemName"></strong>?</p>
                <p class="text-danger"><small>This action cannot be undone.</small></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>

            <form
                id="deleteForm"
                method="POST"
                hx-post="{% url 'delete_product' product.product_id %}"
                hx-target="#modalMessages"
                hx-swap="innerHTML"
            >
                {% csrf_token %}
                <button type="submit" class="btn btn-danger">Delete</button>
            </form>


            </div>
        </div>
    </div>
</div>

<script>

    document.addEventListener('DOMContentLoaded', () => {
        const deleteProductModal = document.getElementById('deleteProductModal');
        const deleteItemName = document.getElementById('deleteItemName');
        const deleteForm = document.getElementById('deleteForm');
        const modalMessages = document.getElementById('modalMessages');

        deleteProductModal.addEventListener('show.bs.modal', (event) => {
            const button = event.relatedTarget;
            const productId = button.getAttribute('data-product-id');
            const productName = button.getAttribute('data-product-name');

            deleteItemName.textContent = productName;
            deleteForm.setAttribute('hx-post', `/products/delete/${productId}/`);

            if (modalMessages) {
                modalMessages.innerHTML = '';
            }
        });

        deleteForm.addEventListener('htmx:afterRequest', (event) => {
            try {
                const response = JSON.parse(event.detail.xhr.responseText);

                if (response.success) {
                    modalMessages.innerHTML = `
                        <div class="alert alert-success">
                            <i class="fas fa-check-circle"></i>
                            ${response.message}
                        </div>
                    `;

                    if (response.action === 'reload') {
                        setTimeout(() => {
                            const modal = bootstrap.Modal.getInstance(deleteProductModal);
                            modal.hide();
                            window.location.reload();
                        }, 1500);
                    }
                } else {
                    modalMessages.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle"></i>
                            ${response.message}
                        </div>
                    `;
                }
            } catch (e) {
                console.error('Error parsing JSON response:', e);
                modalMessages.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle"></i>
                        An unexpected error occurred.
                    </div>
                `;
            }
        });
    });
</script>
